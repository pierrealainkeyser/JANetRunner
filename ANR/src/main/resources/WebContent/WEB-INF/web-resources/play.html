<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="resources/css/bootstrap.css" rel="stylesheet">
<link href="resources/css/anr.css" rel="stylesheet">

<script type="text/javascript" src="resources/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="resources/js/jquery.transit.min.js"></script>
<script type="text/javascript" src="resources/js/mousetrap.min.js"></script>
<script type="text/javascript" src="resources/js/lodash.min.js"></script>

<script type="text/javascript" src="resources/js/jquery.json-2.2.min.js"></script>
<script type="text/javascript" src="resources/js/jquery.websocket-0.0.1.js"></script>

<script type="text/javascript" src="resources/js/anr.js"></script>

<script type="text/javascript">

	

 	function doSetup(game){
 		console.log("setup question->"+JSON.stringify(game.question));
 		console.log("setup step->"+JSON.stringify(game.step));
 		
 		console.log("setup corp->"+JSON.stringify(game.corp));
 		console.log("setup runner->"+JSON.stringify(game.runner)); 		
 		
 		console.debug("setup cards->"+JSON.stringify(game.cards));
 		
 		//prise en compte des wallets
 		updateWallets(game);
 		 		
 		var main = $('div#main');
		for(var k in game.cards){
			var c=createCard(game.cards[k],main);					
			
			//demo d'affichage
			c.widget.click(function() {
				var c=$(this).prop("card");
				
				if (c.isHidden())
					c.show();
				else
					c.hide();
			});		
		}
		
		handleQuestion(game.question);
		
 	}
 	
 	function handleQuestion(q){
 		if(q.qid<125){
 			
 			setTimeout(function(){ 			 			
 				var choosen={qid:q.qid,rid:q.responses[0].rid};
				$ws.send('response',choosen);
 			}, 500);
 		}
 	}
 	
 	function doUpdate(game){
 		console.log("update ->"+JSON.stringify(game));
 		if(game.cards){
 			for(var k in game.cards){
 				var c=game.cards[k];
 				cards[c.id].update(c); 				
 			}
 		}
 		
 		//prise en compte des wallets
 		updateWallets(game);
 		
 		//gestion de la question
 		handleQuestion(game.question);

 	}
 	
 	function updateWallets(game){
 		if(game.corp != undefined && game.corp.wallets != undefined){
 			var w=game.corp.wallets; 			
 			wallets.corp.credits.value(w.credits); 			
 	 		wallets.corp.actions.value(w.actions);	
 		}
 		
 		if(game.runner != undefined && game.runner.wallets != undefined){
 			var w=game.runner.wallets; 			
 			wallets.runner.credits.value(w.credits); 			
 	 		wallets.runner.actions.value(w.actions);	
 		}
 	}
 	
	var $ws;

	$(function() {
		initANR();
		
		var hash= window.location.hash;
		if(!hash)
			return;
			
		var all=hash.match(/(\w+)@(\w+)/);
		var fact=all[1];
		var gid=all[2];
		
		console.log("connecting to "+gid+" as "+fact);
		bootANR(fact);
		
		$ws = $.websocket("ws://127.0.0.1:8082/ws", {
			events: {
				text:function(e) {			
		            console.log("text ->"+JSON.stringify(e));
		        },
		        setup:function(e){	        	 
		        	doSetup(e.data);
		        },
		        update:function(e){
		        	doUpdate(e.data);
		        }
			}				
		});
		$ws.onopen=function(){
			$ws.send('ready',{game:gid});	
		};
			
	
		//binding
		Mousetrap.bind(['up','down','right','left'],function(e,c){
			focusNext(e,c);
		});		
		
		//vers server central
		Mousetrap.bind('e',function(e){
			$("#hq").focus();
		});
		Mousetrap.bind('z',function(e){
			$("#rd").focus();
		});
		Mousetrap.bind('a',function(e){
			$("#archives").focus();
		});		
	
		//vers serveur remote
		for(var i=1;i<15;++i)
			bindRemote(i);
		
		//vers runner
		Mousetrap.bind('q',function(e){
			$("#grip").focus();
		});
		Mousetrap.bind('d',function(e){
			$("#heap").focus();
		});
		Mousetrap.bind('s',function(e){
			$("#stack").focus();
		});
		
		//vers la main
		Mousetrap.bind('h',function(e){
			focusAt(e,{type:'hand',value:{hand:1}});
		});
	});
	
	function bindRemote(i){
		Mousetrap.bind('r '+i,function(e){
			focusAt(e,{type:'server',value:{remote:i-1}});
		});
	}
	
	function focusNext(e,dir){
		e.preventDefault();
		var f=$(":focus")
		var card=f.prop("card");
		if(card){
			var n=card.next(dir);
			if(n)
				n.widget.focus();
		}
		else{
			// le focus est peut-Ãªtre sur un composant qui peut avoir des glaces
			var id=f.attr("id");
			if("hq"==id||"rd"==id||"archives"==id){
				if("up"==dir)
					focusAt(e,{type:'ice',value:{central:id,ice:1}});
			}
		}
	}
	
	function focusAt(e,at){
		e.preventDefault();		   	
		var n=cardAt(at);
		if(n)
			n.widget.focus();		
	}
</script>
</head>
<body>
	<div class="faction corp">
		<p>
			<a><img src="http://netrunnerdb.com/web/bundles/netrunnerdbbuilder/images/factions/38px/nbn.png" /></a>
		</p>
		<div class="expand">
			<p title="Clicks">
				<span><i class="sprite click"></i></span><span class="actions"></span>
			</p>
			<p title="Credits">
				<span><i class="sprite credits"></i></span><span class="credits"></span>
			</p>
		</div>
	</div>

	<div class="faction runner">
		<p>
			<a><img src="http://netrunnerdb.com/web/bundles/netrunnerdbbuilder/images/factions/38px/shaper.png" /></a>
		</p>
		<div class="expand">
			<p title="Clicks">
				<span><i class="sprite click"></i></span><span class="actions"></span>
			</p>
			<p title="Credits">
				<span><i class="sprite credits"></i></span><span class="credits"></span>
			</p>
			<p title="Link">
				<span><i class="sprite link"></i></span><span class="links"></span>
			</p>
			<p title="Memory unit">
				<span><i class="sprite memory_unit"></i></span><span class="memory_units"></span>
			</p>
		</div>
	</div>

	<div id="main">
		<div id="rd" class="cardplace" tabindex="-1">
			R&amp;D (<span>0</span>)
		</div>
		<div id="hq" class="cardplace" tabindex="-1">
			HQ (<span>0</span>)
		</div>
		<div id="archives" class="cardplace" tabindex="-1">
			Archives (<span>0</span>)
		</div>

		<div id="grip" class="cardplace" tabindex="-1">
			Grip(<span>0</span>)
		</div>
		<div id="heap" class="cardplace" tabindex="-1">
			Heap (<span>0</span>)
		</div>
		<div id="stack" class="cardplace" tabindex="-1">
			Stack (<span>0</span>)
		</div>

		<div id="preview">
			<img />
		</div>
	</div>

</body>
</html>