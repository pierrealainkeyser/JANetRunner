<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="resources/css/bootstrap.css" rel="stylesheet">
<link href="resources/css/anr.css" rel="stylesheet">

<script type="text/javascript" src="resources/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="resources/js/jquery.transit.min.js"></script>
<script type="text/javascript" src="resources/js/mousetrap.min.js"></script>
<script type="text/javascript" src="resources/js/lodash.min.js"></script>

<script type="text/javascript" src="resources/js/jquery.json-2.2.min.js"></script>
<script type="text/javascript" src="resources/js/jquery.websocket-0.0.1.js"></script>

<script type="text/javascript" src="resources/js/anr.js"></script>

<script type="text/javascript">

	var ws = $.websocket("ws://127.0.0.1:8082/ws", {
		events: {
			text:function(e) {			
	            console.log("text ->"+JSON.stringify(e));
	        },
	        setup:function(e){	        	 
	        	doSetup(e.data);
	        }
		}				
	});
	ws.onopen=function(){
		ws.send('ready',{game:'ABC342EF'});	
	};

 	function doSetup(setup){
 		
 		console.log("setup ->"+JSON.stringify(setup));
 		var main = $('div#main');
		for(var k in setup.cards){
			var c=createCard(setup.cards[k],main);					
			
			//demo d'affichage
			c.widget.click(function() {
				$(this).prop("card").toggle();
			});		
		}
 		
 		
 		//demo
		/*
		setTimeout(function(){
			cards['8'].location({type:'server',value:{remote:0}});
			cards['5'].location({type:'ice',value:{remote:0,ice:1}});			
		},1500);
		
		setTimeout(function(){			
			cards['2'].location({type:'hq'});
			cards['7'].location({type:'archives'});
			cards['1'].location({type:'hq'});
			cards['6'].location({type:'hq'});
			cards['4'].location({type:'ice',value:{central:'hq',ice:2}});
			cards['3'].location({type:'ice',value:{central:'hq',ice:1}});
			cards['9'].location({type:'ice',value:{central:'rd',ice:1}});
			cards['10'].location({type:'ice',value:{central:'rd',ice:2}});
			cards['11'].location({type:'ice',value:{central:'rd',ice:3}});
			cards['15'].location({type:'heap'});
			cards['16'].location({type:'grip'});
		},3000);
		*/
 	}
	

	$(function() {	
		faction='corp';
		locationHandler = {
			'hq' : new CardCounter($("#hq").find("span")),
			'archives' : new CardCounter($("#archives").find("span")),
			'rd' : new CardCounter($("#rd").find("span")),
			'grip' : new CardCounter($("#grip").find("span")),
			'stack' : new CardCounter($("#stack").find("span")),
			'heap' : new CardCounter($("#heap").find("span"))
		};
		
		if(faction=='corp')
			locationHandler['hand']=locationHandler['hq'];
		else
			locationHandler['hand']=locationHandler['grip'];
		
		$("#archives").css(placeFunction['archives']());
		$("#rd").css(placeFunction['rd']());
		$("#hq").css(placeFunction['hq']());
		
		$("#grip").css(placeFunction['grip']());
		$("#stack").css(placeFunction['stack']());
		$("#heap").css(placeFunction['heap']());
	
		$(".faction.corp").find("a").bind('click', function() {
			var l = $(".faction.corp .expand")
			l.animate({height : 'toggle'},150);
		});
		
		$(".faction.runner").find("a").bind('click', function() {
			var l = $(".faction.runner .expand")
			l.animate({height : 'toggle'},150);
		});
	
	
		//binding
		Mousetrap.bind(['up','down','right','left'],function(e,c){
			focusNext(e,c);
		});		
		
		//vers server central
		Mousetrap.bind('e',function(e){
			$("#hq").focus();
		});
		Mousetrap.bind('z',function(e){
			$("#rd").focus();
		});
		Mousetrap.bind('a',function(e){
			$("#archives").focus();
		});		
	
		//vers serveur remote
		for(var i=1;i<15;++i)
			bindRemote(i);
		
		//vers runner
		Mousetrap.bind('q',function(e){
			$("#grip").focus();
		});
		Mousetrap.bind('d',function(e){
			$("#heap").focus();
		});
		Mousetrap.bind('s',function(e){
			$("#stack").focus();
		});
		
		//vers la main
		Mousetrap.bind('h',function(e){
			focusAt(e,{type:'hand',value:{hand:1}});
		});
	});
	
	function bindRemote(i){
		Mousetrap.bind('r '+i,function(e){
			focusAt(e,{type:'server',value:{remote:i-1}});
		});
	}
	
	function focusNext(e,dir){
		e.preventDefault();
		var f=$(":focus")
		var card=f.prop("card");
		if(card){
			var n=card.next(dir);
			if(n)
				n.widget.focus();
		}
		else{
			// le focus est peut-Ãªtre sur un composant qui peut avoir des glaces
			var id=f.attr("id");
			if("hq"==id||"rd"==id||"archives"==id){
				if("up"==dir)
					focusAt(e,{type:'ice',value:{central:id,ice:1}});
			}
		}
	}
	
	function focusAt(e,at){
		e.preventDefault();		   	
		var n=cardAt(at);
		if(n)
			n.widget.focus();		
	}
</script>
</head>
<body>
	<div class="faction corp">
		<p>
			<a href="#"><img src="http://netrunnerdb.com/web/bundles/netrunnerdbbuilder/images/factions/38px/nbn.png" /></a>
		</p>
		<div class="expand">
			<p title="Clicks">
				<span><i class="sprite click"></i></span><span>1</span>
			</p>
			<p title="Credits">
				<span><i class="sprite credits"></i></span><span>6</span>
			</p>
		</div>
	</div>

	<div class="faction runner">
		<p>
			<a href="#"><img src="http://netrunnerdb.com/web/bundles/netrunnerdbbuilder/images/factions/38px/shaper.png" /></a>
		</p>
		<div class="expand">
			<p title="Clicks">
				<span><i class="sprite click"></i></span><span>0</span>
			</p>
			<p title="Credits">
				<span><i class="sprite credits"></i></span><span>11</span>
			</p>
			<p title="Link">
				<span><i class="sprite link"></i></span><span>0</span>
			</p>
			<p title="Memory unit">
				<span><i class="sprite memory_unit"></i></span><span>4</span>
			</p>
		</div>
	</div>

	<div id="main">
		<div id="rd" class="cardplace" tabindex="-1">
			R&amp;D (<span>0</span>)
		</div>
		<div id="hq" class="cardplace" tabindex="-1">
			HQ (<span>0</span>)
		</div>
		<div id="archives" class="cardplace" tabindex="-1">
			Archives (<span>0</span>)
		</div>

		<div id="grip" class="cardplace" tabindex="-1">
			Grip(<span>0</span>)
		</div>
		<div id="heap" class="cardplace" tabindex="-1">
			Heap (<span>0</span>)
		</div>
		<div id="stack" class="cardplace" tabindex="-1">
			Stack (<span>0</span>)
		</div>

		<div id="preview">
			<img />
		</div>
	</div>

</body>
</html>